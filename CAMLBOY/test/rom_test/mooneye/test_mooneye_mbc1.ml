open Camlboy_lib
module M = Mooneye_utils.Make(Mbc1)

let%expect_test "bits_bank1.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/bits_bank1.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486D
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "bits_bank2.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/bits_bank2.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486D
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "bits_mode.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/bits_mode.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486D
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "bits_ramg.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/bits_ramg.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$02E6 DE:$42F0 HL:$FF40 SP:$E000 PC:$486D
    008:-####-----####-------------------#######----------------------------------------------------#------#------------------#-----------------------------------------
    009:-#---#---#----#---------------------#-----####-----###-----#---------------##-----####-------------#------####--------#-----------------------------------------
    010:-####--------#------#---------------#----#----#---#-------####-------------#----------#-----#------#-----#----#---#####-----------------------------------------
    011:-#-#-------##-----------------------#----######----##------#--------------###-----#####-----#------#-----######--#----#-----------------------------------------
    012:-#--#-----#-------------------------#----#-----------#-----#---------------#-----#---##-----#------#-----#-------#---##-----------------------------------------
    013:-#---#---######-----#---------------#-----####----###------##--------------#------###-#-----#------##-----####----###-#-----------------------------------------
    016:-####------##----#-----#--###---------------#------##-----------------------------------------------------------------------------------------------------------
    017:-#---#-----##----##---##-#---#-------------##------##-----------------------------------------------------------------------------------------------------------
    018:-####-----#--#---#-#-#-##--------######-----#-----#--#----------------------------------------------------------------------------------------------------------
    019:-#-#------####---#--#--##--###--------------#-----####----------------------------------------------------------------------------------------------------------
    020:-#--#----#----#--#-----#-#---#---######-----#----#----#---------------------------------------------------------------------------------------------------------
    021:-#---#---#----#--#-----#--###--------------###---#----#--------------------------------------------------------------------------------------------------------- |}]

let%expect_test "rom_512kb.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/rom_512kb.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0203 DE:$42F1 HL:$FF40 SP:$E000 PC:$486E
    000:-#######-#####-----###---#######---------#####-----##-----#####--#-------#####---####---------------------------------------------------------------------------
    001:----#----#--------#---#-----#------------#---------##-------#----#-------#-------#---#--------------------------------------------------------------------------
    002:----#----####------#--------#------------####-----#--#------#----#-------####----#---#--------------------------------------------------------------------------
    003:----#----#----------##------#------------#--------####------#----#-------#-------#---#--------------------------------------------------------------------------
    004:----#----#--------#---#-----#------------#-------#----#-----#----#-------#-------#---#--------------------------------------------------------------------------
    005:----#----#####-----###------#------------#-------#----#---#####--######--#####---####---------------------------------------------------------------------------
    008:----#-------#------##------##------##---------------#----######--#####---#####---#####--------------------------------------------------------------------------
    009:---####----##-----#--#----#--#----#--#-------------####------#---#-------#-------#------------------------------------------------------------------------------
    010:--#-#-----#-#----#----#--#----#--#----#-----------#-#-------#----####----####----####---------------------------------------------------------------------------
    011:---###---#--#----#----#--#----#--#----#---####-----###-----#-----#-------#-------#------------------------------------------------------------------------------
    012:----#-#--#####----#--#----#--#----#--#--------------#-#---#------#-------#-------#------------------------------------------------------------------------------
    013:--####------#------##------##------##-------------####---#-------#-------#-------#------------------------------------------------------------------------------
    014:----#-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    016:-#-----#---###---####----#####-------------##------##-----------------------------------------------------------------------------------------------------------
    017:-##---##--#---#--#---#---#----------------#--#----#--#----------------------------------------------------------------------------------------------------------
    018:-#-#-#-#--#---#--#---#---####------------#----#--#----#---------------------------------------------------------------------------------------------------------
    019:-#--#--#--#---#--#---#---#---------------#----#--#----#---------------------------------------------------------------------------------------------------------
    020:-#-----#--#---#--#---#---#----------------#--#----#--#----------------------------------------------------------------------------------------------------------
    021:-#-----#---###---####----#####-------------##------##-----------------------------------------------------------------------------------------------------------
    032:-####------##----#----#--#---#-----------#----#--#----#--#-----#-####----#####---####--------------##-------#---------------------------------------------------
    033:-#---#-----##----##---#--#--#------------##---#--#----#--##---##-#---#---#-------#---#------------#--#-----##---------------------------------------------------
    034:-####-----#--#---#-#--#--#-#-------------#-#--#--#----#--#-#-#-#-####----####----####------------#----#---#-#---------------------------------------------------
    035:-#---#----####---#--#-#--###-------------#--#-#--#----#--#--#--#-#---#---#-------#-#-------------#----#--#--#---------------------------------------------------
    036:-#---#---#----#--#---##--#--#------------#---##--#----#--#-----#-#---#---#-------#--#-------------#--#---#####--------------------------------------------------
    037:-####----#----#--#----#--#---#-----------#----#---####---#-----#-####----#####---#---#-------------##-------#---------------------------------------------------
    040:-#####---#----#--####----#####----###----#######-#####---####--------------------------------------##------##---------------------------------------------------
    041:-#--------#--#---#---#---#-------#---#------#----#-------#---#------------------------------------#--#----#--#--------------------------------------------------
    042:-####------##----####----####---#-----------#----####----#---#-----------------------------------#----#--#----#-------------------------------------------------
    043:-#---------##----#-------#------#-----------#----#-------#---#-----------------------------------#----#--#----#-------------------------------------------------
    044:-#--------#--#---#-------#-------#---#------#----#-------#---#------------------------------------#--#----#--#--------------------------------------------------
    045:-#####---#----#--#-------#####----###-------#----#####---####--------------------------------------##------##---------------------------------------------------
    048:---##-----###----#######-#----#----##----#---------------------------------------------------------##-------#---------------------------------------------------
    049:---##----#---#------#----#----#----##----#--------------------------------------------------------#--#-----##---------------------------------------------------
    050:--#--#--#-----------#----#----#---#--#---#-------------------------------------------------------#----#-----#---------------------------------------------------
    051:--####--#-----------#----#----#---####---#-------------------------------------------------------#----#-----#---------------------------------------------------
    052:-#----#--#---#------#----#----#--#----#--#--------------------------------------------------------#--#------#---------------------------------------------------
    053:-#----#---###-------#-----####---#----#--######----------------------------------------------------##------###-------------------------------------------------- |}]

let%expect_test "rom_1Mb.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/rom_1Mb.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0203 DE:$42F1 HL:$FF40 SP:$E000 PC:$486E
    000:-#######-#####-----###---#######---------#####-----##-----#####--#-------#####---####---------------------------------------------------------------------------
    001:----#----#--------#---#-----#------------#---------##-------#----#-------#-------#---#--------------------------------------------------------------------------
    002:----#----####------#--------#------------####-----#--#------#----#-------####----#---#--------------------------------------------------------------------------
    003:----#----#----------##------#------------#--------####------#----#-------#-------#---#--------------------------------------------------------------------------
    004:----#----#--------#---#-----#------------#-------#----#-----#----#-------#-------#---#--------------------------------------------------------------------------
    005:----#----#####-----###------#------------#-------#----#---#####--######--#####---####---------------------------------------------------------------------------
    008:----#-------#------##------##------##---------------#----######--#####---#####---#####--------------------------------------------------------------------------
    009:---####----##-----#--#----#--#----#--#-------------####------#---#-------#-------#------------------------------------------------------------------------------
    010:--#-#-----#-#----#----#--#----#--#----#-----------#-#-------#----####----####----####---------------------------------------------------------------------------
    011:---###---#--#----#----#--#----#--#----#---####-----###-----#-----#-------#-------#------------------------------------------------------------------------------
    012:----#-#--#####----#--#----#--#----#--#--------------#-#---#------#-------#-------#------------------------------------------------------------------------------
    013:--####------#------##------##------##-------------####---#-------#-------#-------#------------------------------------------------------------------------------
    014:----#-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    016:-#-----#---###---####----#####-------------##------##-----------------------------------------------------------------------------------------------------------
    017:-##---##--#---#--#---#---#----------------#--#----#--#----------------------------------------------------------------------------------------------------------
    018:-#-#-#-#--#---#--#---#---####------------#----#--#----#---------------------------------------------------------------------------------------------------------
    019:-#--#--#--#---#--#---#---#---------------#----#--#----#---------------------------------------------------------------------------------------------------------
    020:-#-----#--#---#--#---#---#----------------#--#----#--#----------------------------------------------------------------------------------------------------------
    021:-#-----#---###---####----#####-------------##------##-----------------------------------------------------------------------------------------------------------
    032:-####------##----#----#--#---#-----------#----#--#----#--#-----#-####----#####---####--------------##-----####--------------------------------------------------
    033:-#---#-----##----##---#--#--#------------##---#--#----#--##---##-#---#---#-------#---#------------#--#---#----#-------------------------------------------------
    034:-####-----#--#---#-#--#--#-#-------------#-#--#--#----#--#-#-#-#-####----####----####------------#----#---####--------------------------------------------------
    035:-#---#----####---#--#-#--###-------------#--#-#--#----#--#--#--#-#---#---#-------#-#-------------#----#--#----#-------------------------------------------------
    036:-#---#---#----#--#---##--#--#------------#---##--#----#--#-----#-#---#---#-------#--#-------------#--#---#----#-------------------------------------------------
    037:-####----#----#--#----#--#---#-----------#----#---####---#-----#-####----#####---#---#-------------##-----####--------------------------------------------------
    040:-#####---#----#--####----#####----###----#######-#####---####--------------------------------------##------##---------------------------------------------------
    041:-#--------#--#---#---#---#-------#---#------#----#-------#---#------------------------------------#--#----#--#--------------------------------------------------
    042:-####------##----####----####---#-----------#----####----#---#-----------------------------------#----#--#----#-------------------------------------------------
    043:-#---------##----#-------#------#-----------#----#-------#---#-----------------------------------#----#--#----#-------------------------------------------------
    044:-#--------#--#---#-------#-------#---#------#----#-------#---#------------------------------------#--#----#--#--------------------------------------------------
    045:-#####---#----#--#-------#####----###-------#----#####---####--------------------------------------##------##---------------------------------------------------
    048:---##-----###----#######-#----#----##----#---------------------------------------------------------##-------#---------------------------------------------------
    049:---##----#---#------#----#----#----##----#--------------------------------------------------------#--#-----##---------------------------------------------------
    050:--#--#--#-----------#----#----#---#--#---#-------------------------------------------------------#----#-----#---------------------------------------------------
    051:--####--#-----------#----#----#---####---#-------------------------------------------------------#----#-----#---------------------------------------------------
    052:-#----#--#---#------#----#----#--#----#--#--------------------------------------------------------#--#------#---------------------------------------------------
    053:-#----#---###-------#-----####---#----#--######----------------------------------------------------##------###-------------------------------------------------- |}]

let%expect_test "rom_2Mb.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/rom_2Mb.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0203 DE:$42F1 HL:$FF40 SP:$E000 PC:$486E
    000:-#######-#####-----###---#######---------#####-----##-----#####--#-------#####---####---------------------------------------------------------------------------
    001:----#----#--------#---#-----#------------#---------##-------#----#-------#-------#---#--------------------------------------------------------------------------
    002:----#----####------#--------#------------####-----#--#------#----#-------####----#---#--------------------------------------------------------------------------
    003:----#----#----------##------#------------#--------####------#----#-------#-------#---#--------------------------------------------------------------------------
    004:----#----#--------#---#-----#------------#-------#----#-----#----#-------#-------#---#--------------------------------------------------------------------------
    005:----#----#####-----###------#------------#-------#----#---#####--######--#####---####---------------------------------------------------------------------------
    008:----#-------#------##------##------##---------------#----######--#####---#####---#####--------------------------------------------------------------------------
    009:---####----##-----#--#----#--#----#--#-------------####------#---#-------#-------#------------------------------------------------------------------------------
    010:--#-#-----#-#----#----#--#----#--#----#-----------#-#-------#----####----####----####---------------------------------------------------------------------------
    011:---###---#--#----#----#--#----#--#----#---####-----###-----#-----#-------#-------#------------------------------------------------------------------------------
    012:----#-#--#####----#--#----#--#----#--#--------------#-#---#------#-------#-------#------------------------------------------------------------------------------
    013:--####------#------##------##------##-------------####---#-------#-------#-------#------------------------------------------------------------------------------
    014:----#-----------------------------------------------#-----------------------------------------------------------------------------------------------------------
    016:-#-----#---###---####----#####-------------##------##-----------------------------------------------------------------------------------------------------------
    017:-##---##--#---#--#---#---#----------------#--#----#--#----------------------------------------------------------------------------------------------------------
    018:-#-#-#-#--#---#--#---#---####------------#----#--#----#---------------------------------------------------------------------------------------------------------
    019:-#--#--#--#---#--#---#---#---------------#----#--#----#---------------------------------------------------------------------------------------------------------
    020:-#-----#--#---#--#---#---#----------------#--#----#--#----------------------------------------------------------------------------------------------------------
    021:-#-----#---###---####----#####-------------##------##-----------------------------------------------------------------------------------------------------------
    032:-####------##----#----#--#---#-----------#----#--#----#--#-----#-####----#####---####---------------#------##---------------------------------------------------
    033:-#---#-----##----##---#--#--#------------##---#--#----#--##---##-#---#---#-------#---#-------------##-----#--#--------------------------------------------------
    034:-####-----#--#---#-#--#--#-#-------------#-#--#--#----#--#-#-#-#-####----####----####---------------#----#----#-------------------------------------------------
    035:-#---#----####---#--#-#--###-------------#--#-#--#----#--#--#--#-#---#---#-------#-#----------------#----#----#-------------------------------------------------
    036:-#---#---#----#--#---##--#--#------------#---##--#----#--#-----#-#---#---#-------#--#---------------#-----#--#--------------------------------------------------
    037:-####----#----#--#----#--#---#-----------#----#---####---#-----#-####----#####---#---#-------------###-----##---------------------------------------------------
    040:-#####---#----#--####----#####----###----#######-#####---####--------------------------------------##------##---------------------------------------------------
    041:-#--------#--#---#---#---#-------#---#------#----#-------#---#------------------------------------#--#----#--#--------------------------------------------------
    042:-####------##----####----####---#-----------#----####----#---#-----------------------------------#----#--#----#-------------------------------------------------
    043:-#---------##----#-------#------#-----------#----#-------#---#-----------------------------------#----#--#----#-------------------------------------------------
    044:-#--------#--#---#-------#-------#---#------#----#-------#---#------------------------------------#--#----#--#--------------------------------------------------
    045:-#####---#----#--#-------#####----###-------#----#####---####--------------------------------------##------##---------------------------------------------------
    048:---##-----###----#######-#----#----##----#---------------------------------------------------------##-------#---------------------------------------------------
    049:---##----#---#------#----#----#----##----#--------------------------------------------------------#--#-----##---------------------------------------------------
    050:--#--#--#-----------#----#----#---#--#---#-------------------------------------------------------#----#-----#---------------------------------------------------
    051:--####--#-----------#----#----#---####---#-------------------------------------------------------#----#-----#---------------------------------------------------
    052:-#----#--#---#------#----#----#--#----#--#--------------------------------------------------------#--#------#---------------------------------------------------
    053:-#----#---###-------#-----####---#----#--######----------------------------------------------------##------###-------------------------------------------------- |}]

let%expect_test "rom_4Mb.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/rom_4Mb.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486E
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "rom_16Mb.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/rom_16Mb.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486E
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "ram_64kb.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/ram_64kb.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486D
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]

let%expect_test "ram_256kb.gb" =
  M.run_test_rom_and_print_framebuffer "mbc1/ram_256kb.gb";

  [%expect{|
    A:$00 F:ZN-- BC:$0305 DE:$080D HL:$1522 SP:$E000 PC:$486D
    008:-#######-----------------------------------###---#---#----------------------------------------------------------------------------------------------------------
    009:----#-----####-----###-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    010:----#----#----#---#-------####------------#---#--#-#------------------------------------------------------------------------------------------------------------
    011:----#----######----##------#--------------#---#--###------------------------------------------------------------------------------------------------------------
    012:----#----#-----------#-----#--------------#---#--#--#-----------------------------------------------------------------------------------------------------------
    013:----#-----####----###------##--------------###---#---#---------------------------------------------------------------------------------------------------------- |}]
