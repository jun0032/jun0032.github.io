include Camlboy_lib
open Uints

let area0_start_addr = Uint16.of_int 0x9800
let area1_start_addr = Uint16.of_int 0x9C00

let create () =
  Tile_map.create
    ~area0_start_addr
    ~area0_end_addr:(Uint16.of_int 0x9BFF)
    ~area1_start_addr
    ~area1_end_addr:(Uint16.of_int 0x9FFF)

let print_all_tiles ~area t =
  (* Print top left part of the 256 * 256 frame *)
  for y = 0 to 30 do
    for x = 0 to 60 do
      Tile_map.get_tile_index t ~area ~y ~x
      |> Uint8.to_int
      |> Printf.printf "%d"
    done;
    Printf.printf "\n"
  done

let write t ~area ~y ~x ~data =
  let start = match area with Tile_map.Area0 -> area0_start_addr | Area1 -> area1_start_addr in
  Tile_map.write_byte t ~addr:Uint16.(start + of_int y * of_int 32 + of_int x) ~data:Uint8.(of_int data)

let%expect_test "test write then read" =
  let t = create () in

  (* area0 *)
  Tile_map.write_byte t ~addr:area0_start_addr ~data:Uint8.(of_int 0xAB);
  Tile_map.read_byte t area0_start_addr
  |> Uint8.show
  |> print_endline;

  [%expect {| $AB |}];

  (* area1 *)
  Tile_map.write_byte t ~addr:area1_start_addr ~data:Uint8.(of_int 0xAB);
  Tile_map.read_byte t area1_start_addr
  |> Uint8.show
  |> print_endline;

  [%expect {| $AB |}]

let%expect_test "test write area0" =
  let t = create () in

  write t ~area:Tile_map.Area0 ~y:1 ~x:5 ~data:5;
  print_all_tiles ~area:Area0 t;

  [%expect {|
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000 |}]

let%expect_test "test write area1" =
  let t = create () in

  write t ~area:Tile_map.Area1 ~y:1 ~x:5 ~data:5;
  print_all_tiles ~area:Area1 t;

  [%expect {|
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000555555550000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000
    0000000000000000000000000000000000000000000000000000000000000 |}]
